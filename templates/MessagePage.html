{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'favicon.png' %}" rel="icon" type="image/png">
    <title>Tin nhắn</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'assets/css/icons.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/uikit.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/tailwind.css' %}">
</head>

<body>
    <header>
        <div class="header_inner">
            <div class="left-side">
                <div id="logo" style="margin-right: 10px;">
                    <a href="/">
                        <b style="font-weight: bold;"><h1>UTE Social Network</h1></b>
                    </a>
                </div>
            </div>
            <div class="right-side lg:pr-4">
                <a href="#">
                    {% if request.user.profile.profileimg %}
                        <img src="{{ request.user.profile.profileimg.url }}" class="header-avatar" alt="">
                    {% else %}
                        <img src="/media/profile_images/blank-profile-picture.png" class="header-avatar" alt="">
                    {% endif %}
                </a>
                <div uk-drop="mode: click;offset:9" class="header_dropdown profile_dropdown border-t">
                    <ul>
                        <li><a href="/settings"> Quản lý tài khoản </a></li>
                        <li><a href="/profile/{{request.user.username}}"> Trang cá nhân </a></li>
                        <li><a href="/logout"> Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <div class="container m-auto flex gap-x-6">
        <!-- left sidebar-->
        <div class="space-y-5 flex-shrink-0 lg:w-4/12 mr-4"> 
            <div class="bg-white shadow-md rounded-md overflow-hidden">
                <!-- Tiêu đề -->
                <div class="bg-gray-50 border-b border-gray-100 flex items-baseline justify-between py-4 px-6">
                    <h2 class="font-semibold text-lg">Tin nhắn</h2>
                </div>
        
                <!-- Danh sách tin nhắn -->
                <div class="divide-y divide-gray-100 px-4" id="chat-list">
                    {% for user in chat_users %}
                    <div class="flex items-start space-x-4 py-4 chat-user" data-user-id="{{ user.id }}">
                        {% if user.profile.profileimg %}
                            <img src="{{ user.profile.profileimg.url }}" class="w-10 h-10 rounded-full object-cover" alt="Avatar">
                        {% else %}
                            <img src="/media/profile_images/blank-profile-picture.png" class="w-10 h-10 rounded-full object-cover" alt="Avatar">
                        {% endif %}
                        <div class="flex-1">
                            <span class="block font-semibold text-gray-800">{{ user.username }}</span>
                            <p class="text-sm text-gray-600 last-message"></p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- right sidebar-->
        <div class="lg:w-8/12">
            <div class="bg-white shadow-md rounded-md overflow-hidden">
                {% if selected_user %}
                <!-- Tiêu đề -->
                <div class="bg-gray-50 border-b border-gray-100 flex items-center justify-between py-4 px-6">
                    <h2 class="font-semibold text-lg">Tin nhắn với {{ selected_user.username }}</h2>
                </div>
            
                <!-- Khung cuộn chứa tin nhắn -->
                <div class="max-h-[500px] overflow-y-scroll px-6 py-4 space-y-4" id="messages-container">
                    {% for message in messages %}
                        {% if message.sender == request.user %}
                            <div class="flex items-start justify-end space-x-3">
                                <div class="bg-blue-600 text-white px-4 py-2 rounded-lg max-w-[75%]">
                                    <p class="text-sm">{{ message.content }}</p>
                                    <span class="text-xs text-gray-300">{{ message.created_at|time:"H:i" }}</span>
                                </div>
                                {% if request.user.profile.profileimg %}
                                    <img src="{{ request.user.profile.profileimg.url }}" class="w-9 h-9 rounded-full object-cover" alt="Avatar của bạn">
                                {% else %}
                                    <img src="/media/profile_images/blank-profile-picture.png" class="w-9 h-9 rounded-full object-cover" alt="Avatar của bạn">
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="flex items-start space-x-3">
                                {% if message.sender.profile.profileimg %}
                                    <img src="{{ message.sender.profile.profileimg.url }}" class="w-9 h-9 rounded-full object-cover" alt="Avatar">
                                {% else %}
                                    <img src="/media/profile_images/blank-profile-picture.png" class="w-9 h-9 rounded-full object-cover" alt="Avatar">
                                {% endif %}
                                <div class="bg-gray-100 px-4 py-2 rounded-lg max-w-[75%]">
                                    <p class="text-sm text-gray-800">{{ message.content }}</p>
                                    <span class="text-xs text-gray-500">{{ message.created_at|time:"H:i" }}</span>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            
                <!-- Khung nhập tin nhắn -->
                <div class="border-t border-gray-100 px-4 py-3">
                    <form id="message-form" data-receiver-id="{{ selected_user.id }}">
                        {% csrf_token %}
                        <div class="flex items-center space-x-3">
                            <input type="text" id="message-input" placeholder="Nhập tin nhắn..." 
                                   class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                            <button type="submit" class="bg-blue-600 text-white rounded-full px-4 py-2 text-sm hover:bg-blue-700">Gửi</button>
                        </div>
                    </form>
                </div>
                {% else %}
                <div class="p-6 text-center text-gray-500">
                    Chọn một người dùng để bắt đầu cuộc trò chuyện
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{% static 'assets/js/jquery-3.3.1.min.js' %}"></script>
    <script>
        $(document).ready(function() {
            // Click vào người dùng trong danh sách
            $('.chat-user').click(function() {
                const userId = $(this).data('user-id');
                window.location.href = `/messages/?user_id=${userId}`;
            });

            // Gửi tin nhắn
            $('#message-form').submit(function(e) {
                e.preventDefault();
                const receiverId = $(this).data('receiver-id');
                const content = $('#message-input').val().trim();
                
                if (content) {
                    $.ajax({
                        url: '/send-message/',
                        type: 'POST',
                        data: {
                            receiver_id: receiverId,
                            content: content,
                            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                                // Thêm tin nhắn mới vào khung chat
                                const messageHtml = `
                                    <div class="flex items-start justify-end space-x-3">
                                        <div class="bg-blue-600 text-white px-4 py-2 rounded-lg max-w-[75%]">
                                            <p class="text-sm">${response.message.content}</p>
                                            <span class="text-xs text-gray-300">${response.message.created_at}</span>
                                        </div>
                                        <img src="${$('.header-avatar').attr('src')}" class="w-9 h-9 rounded-full object-cover" alt="Avatar của bạn">
                                    </div>
                                `;
                                $('#messages-container').append(messageHtml);
                                $('#message-input').val('');
                                
                                // Cuộn xuống tin nhắn mới nhất
                                const container = $('#messages-container');
                                container.scrollTop(container[0].scrollHeight);
                            }
                        }
                    });
                }
            });

            // Cuộn xuống tin nhắn mới nhất khi tải trang
            const container = $('#messages-container');
            container.scrollTop(container[0].scrollHeight);

            // Cập nhật tin nhắn mỗi 5 giây
            {% if selected_user %}
            setInterval(function() {
                $.get(`/get-messages/{{ selected_user.id }}/`, function(response) {
                    if (response.status === 'success') {
                        updateMessages(response.messages);
                    }
                });
            }, 5000);
            {% endif %}

            function updateMessages(messages) {
                const container = $('#messages-container');
                container.empty();
                
                messages.forEach(function(message) {
                    const isSender = message.sender_id === {{ request.user.id }};
                    const messageHtml = isSender ? `
                        <div class="flex items-start justify-end space-x-3">
                            <div class="bg-blue-600 text-white px-4 py-2 rounded-lg max-w-[75%]">
                                <p class="text-sm">${message.content}</p>
                                <span class="text-xs text-gray-300">${message.created_at}</span>
                            </div>
                            <img src="${$('.header-avatar').attr('src')}" class="w-9 h-9 rounded-full object-cover" alt="Avatar của bạn">
                        </div>
                    ` : `
                        <div class="flex items-start space-x-3">
                            <img src="${$('.chat-user[data-user-id="{{ selected_user.id }}"] img').attr('src')}" class="w-9 h-9 rounded-full object-cover" alt="Avatar">
                            <div class="bg-gray-100 px-4 py-2 rounded-lg max-w-[75%]">
                                <p class="text-sm text-gray-800">${message.content}</p>
                                <span class="text-xs text-gray-500">${message.created_at}</span>
                            </div>
                        </div>
                    `;
                    container.append(messageHtml);
                });
                
                container.scrollTop(container[0].scrollHeight);
            }
        });
    </script>
</body>
</html>